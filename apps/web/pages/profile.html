<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Gesti√≥n de Laboratorios</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h2>üî¨ Gesti√≥n de Laboratorios</h2>
            </div>
            <div class="navbar-menu">
                <a href="./notifications.html" class="navbar-notifications">
                    üîî
                </a>
                <div class="navbar-user">
                    <span id="userName">Cargando...</span>
                    <button class="btn btn-sm btn-outline" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul id="sidebarMenu" class="sidebar-menu">
           
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <div>
                    <h1>üë§ Mi Perfil - <span id="profileHeaderName">Cargando...</span></h1>
                    <p class="text-secondary">Gestiona tu informaci√≥n personal y revisa tu actividad</p>
                </div>
            </div>

            <!-- Estad√≠sticas R√°pidas -->
            <div class="card mt-lg">
                <div class="card-header">
                    <h3>üìä Resumen de Actividad</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-3">
                        <div class="stat-box">
                            <div class="stat-icon">üìã</div>
                            <h4 class="stat-number" id="totalRequests">0</h4>
                            <p class="text-secondary">Solicitudes Totales</p>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">üìö</div>
                            <h4 class="stat-number" id="totalReservations">0</h4>
                            <p class="text-secondary">Reservas Completadas</p>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">üéì</div>
                            <h4 class="stat-number" id="totalTrainings">0</h4>
                            <p class="text-secondary">Capacitaciones</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Personal -->
            <div class="card mt-lg">
                <div class="card-header">
                    <h2>üìù Informaci√≥n Personal</h2>
                    <button class="btn btn-primary" id="editBtn" onclick="toggleEditMode()">Editar</button>
                </div>
                <div class="card-body">
                    <form id="profileForm" class="profile-form">
                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label>Nombre Completo *</label>
                                <input type="text" id="fullName" class="form-control" required disabled>
                            </div>
                            <div class="form-group">
                                <label>Carn√© / Identificaci√≥n *</label>
                                <input type="text" id="studentId" class="form-control" required disabled>
                            </div>
                            <div class="form-group">
                                <label>Correo Electr√≥nico *</label>
                                <input type="email" id="email" class="form-control" required disabled>
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel" id="phone" class="form-control" disabled>
                            </div>
                            <div class="form-group">
                                <label>Departamento / Carrera *</label>
                                <select id="department" class="form-control" required disabled>
                                    <option value="">Seleccionar...</option>
                                    <option value="Ingenier√≠a en Computaci√≥n">Ingenier√≠a en Computaci√≥n</option>
                                    <option value="Ingenier√≠a Electr√≥nica">Ingenier√≠a Electr√≥nica</option>
                                    <option value="Ingenier√≠a Mecatr√≥nica">Ingenier√≠a Mecatr√≥nica</option>
                                    <option value="Ingenier√≠a Ambiental">Ingenier√≠a Ambiental</option>
                                    <option value="Administraci√≥n">Administraci√≥n</option>
                                    <option value="Biolog√≠a">Biolog√≠a</option>
                                    <option value="Qu√≠mica">Qu√≠mica</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Rol</label>
                                <input type="text" id="role" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="form-actions" id="formActions" style="display: none;">
                            <button type="button" class="btn btn-outline" onclick="cancelEdit()">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Actividad Reciente -->
            <div class="card mt-lg">
                <div class="card-header">
                    <h2>üïê Actividad Reciente</h2>
                    <a href="./history.html" class="btn btn-outline btn-sm">Ver Todo</a>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Descripci√≥n</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <tr>
                                    <td colspan="4" class="text-center">Cargando actividad reciente...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
import api from '../assets/js/api.js';
import { formatDate, showNotification } from '../assets/js/utils.js';
import { requireAuth, logout as authLogout } from '../assets/js/auth.js';

// AUTENTICACI√ìN
requireAuth();
window.logout = authLogout;

// SIDEBAR DIN√ÅMICO ‚Äî AHORA BASADO EN api.getProfile()
function renderSidebar(role) {
    console.log("entre",role);
    const sidebar = document.getElementById("sidebarMenu");

    if (role === "technician") {

        sidebar.innerHTML = `
            <li class="sidebar-item">
                <a href="./search-tech.html">üìã Solicitudes Aprobadas</a>
            </li>
            <li class="sidebar-item">
                <a href=".inventory.html">üì¶ Inventario</a>
            </li>
            <li class="sidebar-item">
                <a href="./maintenance.html">üß∞ Mantenimientos</a>
            </li>
            <li class="sidebar-item">
                <a href="../reports.html">üìä Reportes</a>
            </li>
            <li class="sidebar-item">
                <a href="./notifications.html">üîî Notificaciones</a>
            </li>
            <li class="sidebar-item active">
                <a href="./profile.html">üë§ Mi Perfil</a>
            </li>
        `;

        document.querySelector(".navbar-brand h2").textContent = "üîß Panel T√©cnico";

    } else {

        sidebar.innerHTML = `
            <li class="sidebar-item">
                <a href="./dashboard.html">üè† Dashboard</a>
            </li>
            <li class="sidebar-item">
                <a href="./search.html">üîç Buscar Recursos</a>
            </li>
            <li class="sidebar-item">
                <a href="./requests.html">üìã Mis Solicitudes</a>
            </li>
            <li class="sidebar-item">
                <a href="./history.html">üìö Historial</a>
            </li>
            <li class="sidebar-item active">
                <a href="./profile.html">üë§ Mi Perfil</a>
            </li>
            <li class="sidebar-item">
                <a href="./notifications.html">üîî Notificaciones</a>
            </li>
        `;

        document.querySelector(".navbar-brand h2").textContent = "üî¨ Gesti√≥n de Laboratorios";
    }
}

// VARIABLES
let originalData = {};
let isEditMode = false;

// CARGAR PERFIL COMPLETO
async function loadProfile() {
    try {        
        // ‚Üê‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
        const profile = await api.getProfile();     // USAMOS LA API REAL
        console.log(profile);
        // ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Üí

        // Sidebar ahora se genera con el rol real del usuario
        renderSidebar(profile.role);

        document.getElementById('userName').textContent = profile.name;
        document.getElementById('profileHeaderName').textContent = profile.name;

        document.getElementById('fullName').value = profile.name || 'N/A';
        document.getElementById('studentId').value = profile.student_id || profile.id || 'N/A';
        document.getElementById('email').value = profile.email || 'N/A';
        document.getElementById('phone').value = profile.phone || '';
        document.getElementById('department').value = profile.department || '';
        document.getElementById('role').value = profile.role;

        originalData = { ...profile };

        await loadStatistics();
        await loadRecentActivity();

    } catch (error) {
        console.error('[Profile] Error cargando perfil:', error);
        showNotification('No se pudo cargar el perfil', 'error');
    }
}

// ESTAD√çSTICAS
async function loadStatistics() {
    try {
        const requests = await api.getRequests();
        document.getElementById('totalRequests').textContent = requests.length;

        const history = await api.getHistory();
        document.getElementById('totalReservations').textContent =
            history.filter(h => h.type === 'reservation').length;

        document.getElementById('totalTrainings').textContent =
            history.filter(h => h.type === 'training').length;

    } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
    }
}

// ACTIVIDAD RECIENTE
async function loadRecentActivity() {
    try {
        const history = await api.getHistory();
        const requests = await api.getRequests();

        const allActivity = [
            ...history.map(h => ({
                type: h.type === 'reservation' ? 'üìö Reserva' : 'üéì Capacitaci√≥n',
                description: h.resource_name || h.title,
                date: h.date,
                status: h.status
            })),
            ...requests.map(r => ({
                type: 'üìã Solicitud',
                description: r.resource_name,
                date: r.created_at,
                status: r.status
            }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

        const tbody = document.getElementById('recentActivity');

        if (allActivity.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay actividad reciente</td></tr>';
            return;
        }

        tbody.innerHTML = allActivity.map(a => `
            <tr>
                <td>${a.type}</td>
                <td>${a.description}</td>
                <td>${formatDate(a.date, 'DD/MM/YYYY')}</td>
                <td><span class="badge badge-${a.status}">${getStatusText(a.status)}</span></td>
            </tr>
        `).join('');

    } catch (error) {
        console.error('Error al cargar actividad reciente:', error);
    }
}

function getStatusText(status) {
    const map = {
        pending: 'Pendiente',
        approved: 'Aprobada',
        rejected: 'Rechazada',
        completed: 'Completada',
        cancelled: 'Cancelada',
        'no-show': 'No asisti√≥'
    };
    return map[status] || status;
}

// MODO EDICI√ìN
window.toggleEditMode = function() {
    isEditMode = !isEditMode;

    const fields = ['fullName', 'studentId', 'email', 'phone', 'department'];
    const editBtn = document.getElementById('editBtn');
    const formActions = document.getElementById('formActions');

    if (isEditMode) {
        fields.forEach(field => {
            const input = document.getElementById(field);
            if (field !== 'email' && field !== 'studentId') input.disabled = false;
        });
        editBtn.style.display = 'none';
        formActions.style.display = 'flex';
    } else {
        fields.forEach(field => document.getElementById(field).disabled = true);
        editBtn.style.display = 'inline-block';
        formActions.style.display = 'none';
    }
};

window.cancelEdit = function() {
    document.getElementById('fullName').value = originalData.name;
    document.getElementById('phone').value = originalData.phone || '';
    document.getElementById('department').value = originalData.department || '';
    toggleEditMode();
};

document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        const updatedData = {
            name: document.getElementById('fullName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            department: document.getElementById('department').value
        };

        await api.updateProfile(updatedData);

        originalData = { ...originalData, ...updatedData };

        document.getElementById('profileHeaderName').textContent = updatedData.name;
        document.getElementById('userName').textContent = updatedData.name;

        showNotification('Perfil actualizado exitosamente', 'success');
        toggleEditMode();

    } catch (error) {
        console.error('[Profile] Error al actualizar perfil:', error);
        showNotification('Error al actualizar el perfil', 'error');
    }
});

// INICIO
loadProfile();
</script>


    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .navbar-container {
            height: 100%;
            padding: 0 var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand h2 {
            margin: 0;
            font-size: var(--font-size-xl);
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .navbar-notifications {
            position: relative;
            font-size: var(--font-size-2xl);
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: var(--spacing-lg) 0;
        }

        .sidebar-item {
            margin-bottom: var(--spacing-xs);
        }

        .sidebar-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .sidebar-item a:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sidebar-item.active a {
            background: var(--primary-light);
            color: white;
            font-weight: 500;
        }

        .sidebar-icon {
            font-size: var(--font-size-xl);
            width: 24px;
            text-align: center;
        }

        .page-header {
            margin-bottom: var(--spacing-lg);
        }

        .stat-box {
            text-align: center;
            padding: var(--spacing-md);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: bold;
            color: var(--primary);
            margin: var(--spacing-xs) 0;
        }

        .profile-form {
            max-width: 100%;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .span-2 {
            grid-column: span 2;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .navbar-brand h2 {
                font-size: var(--font-size-lg);
            }

            .grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .span-2 {
                grid-column: span 1;
            }
        }
    </style>
</body>
</html>
