<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Recursos - Gesti√≥n de Laboratorios</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h2>üî¨ Gesti√≥n de Laboratorios</h2>
            </div>
            <div class="navbar-menu">
                <a href="./notifications.html" class="navbar-notifications">
                    üîî
                </a>
                <div class="navbar-user">
                    <span id="userName">Cargando...</span>
                    <button class="btn btn-sm btn-outline" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="./dashboard.html">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item active">
                <a href="./search.html">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Recursos</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./requests.html">
                    <span class="sidebar-icon">üìã</span>
                    <span>Mis Solicitudes</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./history.html">
                    <span class="sidebar-icon">üìö</span>
                    <span>Historial</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./profile.html">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./notifications.html">
                    <span class="sidebar-icon">üîî</span>
                    <span>Notificaciones</span>
                    <span class="badge badge-error">3</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1>üîç Buscar Recursos y Laboratorios</h1>
            <p class="text-secondary">Encuentra equipos y espacios disponibles para tus proyectos</p>

            <!-- Search Filters -->
            <div class="card mt-xl">
                <div class="card-body">
                    <form id="searchForm">
                        <div class="grid grid-cols-3">
                            <div class="form-group">
                                <label for="searchQuery">Buscar por nombre</label>
                                <input type="text" id="searchQuery" placeholder="Ej: Arduino, Osciloscopio...">
                            </div>
                            
                            <div class="form-group">
                                <label for="categoryFilter">Tipo de Recurso</label>
                                <select id="categoryFilter">
                                    <option value="">Todos los tipos</option>
                                    <option value="EQUIPMENT">Equipamiento</option>
                                    <option value="CONSUMABLE">Consumible</option>
                                    <option value="SOFTWARE">Software</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="statusFilter">Estado</label>
                                <select id="statusFilter">
                                    <option value="">Todos</option>
                                    <option value="DISPONIBLE">Disponible</option>
                                    <option value="RESERVADO">Reservado</option>
                                    <option value="EN_MANTENIMIENTO">En Mantenimiento</option>
                                    <option value="INACTIVO">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-md">
                            <button type="submit" class="btn btn-primary">Buscar</button>
                            <button type="button" class="btn btn-outline" onclick="clearFilters()">Limpiar Filtros</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Tabs -->
            <div class="mt-xl">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="labs">Laboratorios (4)</button>
                    <button class="tab-btn" data-tab="resources">Recursos (5)</button>
                </div>

                <!-- Labs Results -->
                <div id="labs-content" class="tab-content active">
                    <div class="grid grid-cols-2 mt-lg" id="labsContainer">
                        <p class="text-secondary">Cargando laboratorios...</p>
                    </div>
                </div>

                <!-- Resources Results -->
                <div id="resources-content" class="tab-content">
                    <div class="grid grid-cols-3 mt-lg" id="resourcesContainer">
                        <p class="text-secondary">Cargando recursos...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para detalles -->
    <div id="detailsModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Detalles</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script type="module">
        import api from '../assets/js/api.js';
        import { formatDate, showNotification } from '../assets/js/utils.js';
        import { requireAuth, getCurrentUser, logout as authLogout } from '../assets/js/auth.js';

        requireAuth();
        window.logout = authLogout;

        // Cargar informaci√≥n del usuario
        async function loadUserInfo() {
            try {
                const profile = await api.getProfile();
                document.getElementById('userName').textContent = profile.name || 'Usuario';
            } catch (error) {
                console.error('[Search] Error al cargar perfil:', error);
                const user = getCurrentUser();
                if (user) {
                    document.getElementById('userName').textContent = user.name;
                }
            }
        }

        let currentLabs = [];
        let currentResources = [];
        let activeTab = 'labs'; // Pesta√±a activa por defecto

        // Cargar datos iniciales
        async function loadData(filters = {}) {
            try {
                currentLabs = await api.searchLabs(filters);
                currentResources = await api.searchResources(filters);
                
                renderLabs(currentLabs);
                renderResources(currentResources);
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showNotification('Error al cargar datos', 'error');
            }
        }

        function renderLabs(labs) {
            const container = document.getElementById('labsContainer');
            
            if (labs.length === 0) {
                container.innerHTML = '<p class="text-secondary">No se encontraron laboratorios</p>';
                return;
            }
            
            container.innerHTML = labs.map(lab => `
                <div class="card">
                    <div class="card-body">
                        <h3>${lab.name}</h3>
                        <p class="text-secondary">${lab.description || 'Sin descripci√≥n'}</p>
                        
                        <div class="mt-md">
                            <p><strong>üìç Ubicaci√≥n:</strong> ${lab.location || 'No especificada'}</p>
                            <p><strong>üîñ C√≥digo:</strong> ${lab.code || 'N/A'}</p>
                            ${lab.capacity ? `<p><strong>üë• Capacidad:</strong> ${lab.capacity} personas</p>` : ''}
                            <p><strong>‚úÖ Elegible:</strong> ${lab.eligible ? 'S√≠' : 'Requiere capacitaci√≥n'}</p>
                        </div>
                        
                        <div class="mt-md">
                            <button class="btn btn-primary btn-block" onclick="viewLabDetails(${lab.id})">
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar contador
            document.querySelector('[data-tab="labs"]').textContent = `Laboratorios (${labs.length})`;
        }

        function renderResources(resources) {
            const container = document.getElementById('resourcesContainer');
            
            if (resources.length === 0) {
                container.innerHTML = '<p class="text-secondary">No se encontraron recursos</p>';
                return;
            }
            
            container.innerHTML = resources.map(resource => `
                <div class="card">
                    <div class="card-body">
                        <h4>${resource.name}</h4>
                        <p class="text-secondary">${resource.description || 'Sin descripci√≥n'}</p>
                        
                        <div class="mt-md">
                            <p><strong>Tipo:</strong> ${resource.type || 'N/A'}</p>
                            <p><strong>Laboratorio:</strong> ${resource.lab_name || 'N/A'}</p>
                            ${resource.inventory_code ? `<p><strong>C√≥digo:</strong> ${resource.inventory_code}</p>` : ''}
                            <p><strong>Estado:</strong> <span class="badge badge-${
                                resource.status === 'DISPONIBLE' ? 'success' :
                                resource.status === 'RESERVADO' ? 'warning' : 
                                resource.status === 'EN_MANTENIMIENTO' ? 'error' : 'secondary'
                            }">${resource.status}</span></p>
                            <p><strong>‚úÖ Elegible:</strong> ${resource.eligible ? 'S√≠' : 'Requiere capacitaci√≥n'}</p>
                        </div>
                        
                        <div class="mt-md">
                            <button class="btn btn-primary btn-block" 
                                    onclick="viewResourceDetails(${resource.id})"
                                    ${resource.status !== 'DISPONIBLE' ? 'disabled' : ''}>
                                ${resource.status === 'DISPONIBLE' ? 'Ver Detalles' : resource.status}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Actualizar contador
            document.querySelector('[data-tab="resources"]').textContent = `Recursos (${resources.length})`;
        }

        // B√∫squeda y filtros
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            applyFilters();
        });

        async function applyFilters() {
            const query = document.getElementById('searchQuery').value.trim();
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            try {
                // Preparar filtros para el backend
                const filters = {};
                if (query) filters.q = query;
                
                // Buscar laboratorios (con query)
                currentLabs = await api.searchLabs(filters);
                
                // Buscar recursos (con todos los filtros)
                const resourceFilters = { ...filters };
                if (category) resourceFilters.type_id = category;
                if (status) resourceFilters.show_all = true; // Para mostrar todos los estados
                
                currentResources = await api.searchResources(resourceFilters);
                
                // Filtrar recursos por estado en el frontend (si se seleccion√≥)
                let filteredResources = currentResources;
                if (status) {
                    filteredResources = currentResources.filter(res => res.status === status);
                }
                
                renderLabs(currentLabs);
                renderResources(filteredResources);
                
                // Mostrar notificaci√≥n seg√∫n la pesta√±a activa
                const count = activeTab === 'labs' ? currentLabs.length : filteredResources.length;
                const type = activeTab === 'labs' ? 'laboratorios' : 'recursos';
                showNotification(`${count} ${type} encontrados`, 'success');
            } catch (error) {
                console.error('Error al filtrar:', error);
                showNotification('Error al aplicar filtros', 'error');
            }
        }

        window.clearFilters = function() {
            document.getElementById('searchForm').reset();
            loadData(); // Recargar todos los datos sin filtros
            showNotification('Filtros limpiados', 'info');
        };

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                activeTab = tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${tab}-content`).classList.add('active');
                
                // Mostrar/ocultar filtros espec√≠ficos de recursos
                const categoryFilter = document.getElementById('categoryFilter').parentElement;
                const statusFilter = document.getElementById('statusFilter').parentElement;
                
                if (tab === 'labs') {
                    // En laboratorios, ocultar filtros de tipo y estado
                    categoryFilter.style.display = 'none';
                    statusFilter.style.display = 'none';
                    // Limpiar los filtros para evitar confusi√≥n
                    document.getElementById('categoryFilter').value = '';
                    document.getElementById('statusFilter').value = '';
                } else {
                    // En recursos, mostrar todos los filtros
                    categoryFilter.style.display = 'block';
                    statusFilter.style.display = 'block';
                }
            });
        });

        // Modal
        window.viewLabDetails = function(id) {
            console.log('Buscando lab con id:', id, 'en:', currentLabs);
            const lab = currentLabs.find(l => l.id == id); // Usar == para comparaci√≥n flexible
            if (!lab) {
                console.error('Lab no encontrado. IDs disponibles:', currentLabs.map(l => l.id));
                showNotification('Laboratorio no encontrado', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = lab.name;
            document.getElementById('modalBody').innerHTML = `
                <div>
                    <p class="text-secondary">${lab.description || 'Sin descripci√≥n disponible'}</p>
                    
                    <h4 class="mt-lg">üìã Informaci√≥n General</h4>
                    <ul>
                        <li><strong>üìç Ubicaci√≥n:</strong> ${lab.location || 'No especificada'}</li>
                        <li><strong>üîñ C√≥digo:</strong> ${lab.code || 'N/A'}</li>
                        ${lab.capacity ? `<li><strong>üë• Capacidad:</strong> ${lab.capacity} personas</li>` : ''}
                        <li><strong>‚úÖ Elegible:</strong> ${lab.eligible ? 'S√≠, puedes usar este laboratorio' : 'No, requiere capacitaci√≥n'}</li>
                    </ul>
                    
                    ${!lab.eligible ? `
                        <div class="mt-md" style="padding: 1rem; background: var(--warning-bg); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <p><strong>‚ö†Ô∏è Capacitaci√≥n Requerida</strong></p>
                            <p class="text-secondary">Para acceder a este laboratorio necesitas completar una capacitaci√≥n previa.</p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-lg">
                        <button class="btn btn-primary btn-block" onclick="createRequestFromModal()">
                            Solicitar Reserva
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('detailsModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Bloquear scroll del body
        };

        window.viewResourceDetails = function(id) {
            console.log('Buscando recurso con id:', id, 'en:', currentResources);
            const resource = currentResources.find(r => r.id == id); // Usar == para comparaci√≥n flexible
            if (!resource) {
                console.error('Recurso no encontrado. IDs disponibles:', currentResources.map(r => r.id));
                showNotification('Recurso no encontrado', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = resource.name;
            document.getElementById('modalBody').innerHTML = `
                <div>
                    <p class="text-secondary">${resource.description || 'Sin descripci√≥n disponible'}</p>
                    
                    <h4 class="mt-lg">üìã Informaci√≥n General</h4>
                    <ul>
                        <li><strong>üè∑Ô∏è Tipo:</strong> ${resource.type || 'N/A'}</li>
                        <li><strong>üî¨ Laboratorio:</strong> ${resource.lab_name || 'N/A'}</li>
                        ${resource.inventory_code ? `<li><strong>üîñ C√≥digo de Inventario:</strong> ${resource.inventory_code}</li>` : ''}
                        ${resource.location ? `<li><strong>üìç Ubicaci√≥n:</strong> ${resource.location}</li>` : ''}
                        <li><strong>üìä Estado:</strong> <span class="badge badge-${
                            resource.status === 'DISPONIBLE' ? 'success' :
                            resource.status === 'RESERVADO' ? 'warning' : 
                            resource.status === 'EN_MANTENIMIENTO' ? 'error' : 'secondary'
                        }">${resource.status}</span></li>
                        <li><strong>‚úÖ Elegible:</strong> ${resource.eligible ? 'S√≠, puedes solicitar este recurso' : 'No, requiere capacitaci√≥n'}</li>
                        ${resource.next_start ? `<li><strong>üìÖ Pr√≥xima disponibilidad:</strong> ${formatDate(resource.next_start)}</li>` : ''}
                    </ul>
                    
                    ${!resource.eligible ? `
                        <div class="mt-md" style="padding: 1rem; background: var(--warning-bg); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <p><strong>‚ö†Ô∏è Capacitaci√≥n Requerida</strong></p>
                            <p class="text-secondary">Para usar este recurso necesitas completar la capacitaci√≥n del laboratorio asociado.</p>
                        </div>
                    ` : ''}
                    
                    ${resource.status !== 'DISPONIBLE' ? `
                        <div class="mt-md" style="padding: 1rem; background: var(--error-bg); border-radius: 8px; border-left: 4px solid var(--error);">
                            <p><strong>‚õî No Disponible</strong></p>
                            <p class="text-secondary">Este recurso no est√° disponible actualmente. Estado: ${resource.status}</p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-lg">
                        <button class="btn btn-primary btn-block" 
                                onclick="createRequestFromModal()"
                                ${resource.status !== 'DISPONIBLE' ? 'disabled' : ''}>
                            ${resource.status === 'DISPONIBLE' ? 'Solicitar Recurso' : 'No Disponible'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('detailsModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Bloquear scroll del body
        };

        window.closeModal = function() {
            document.getElementById('detailsModal').classList.remove('show');
            document.body.style.overflow = ''; // Restaurar scroll del body
        };

        window.createRequestFromModal = function() {
            closeModal();
            window.location.href = './new-request.html';
        };

        // Inicializar filtros seg√∫n la pesta√±a activa (labs por defecto)
        function initializeFilters() {
            const categoryFilter = document.getElementById('categoryFilter').parentElement;
            const statusFilter = document.getElementById('statusFilter').parentElement;
            
            if (activeTab === 'labs') {
                categoryFilter.style.display = 'none';
                statusFilter.style.display = 'none';
            } else {
                categoryFilter.style.display = 'block';
                statusFilter.style.display = 'block';
            }
        }

        // Cargar datos al iniciar
        loadUserInfo();
        initializeFilters();
        loadData();
    </script>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .navbar-container {
            height: 100%;
            padding: 0 var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand h2 {
            margin: 0;
            font-size: var(--font-size-xl);
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .navbar-notifications {
            position: relative;
            font-size: var(--font-size-2xl);
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: var(--spacing-lg) 0;
        }

        .sidebar-item {
            margin-bottom: var(--spacing-xs);
        }

        .sidebar-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .sidebar-item a:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sidebar-item.active a {
            background: var(--primary-light);
            color: white;
            font-weight: 500;
        }

        .sidebar-icon {
            font-size: var(--font-size-xl);
            width: 24px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: var(--spacing-md);
            border-bottom: 2px solid var(--border-color);
        }

        .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .grid-cols-2,
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
