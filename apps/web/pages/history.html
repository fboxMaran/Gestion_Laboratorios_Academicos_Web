<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial - Gesti√≥n de Laboratorios</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS para exportar Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h2>üî¨ Gesti√≥n de Laboratorios</h2>
            </div>
            <div class="navbar-menu">
                <a href="./notifications.html" class="navbar-notifications">
                    <span class="notification-badge" id="notificationCount">0</span>
                    üîî
                </a>
                <div class="navbar-user">
                    <span id="userName">Cargando...</span>
                    <button class="btn btn-sm btn-outline" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="./dashboard.html">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./search.html">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Recursos</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./requests.html">
                    <span class="sidebar-icon">üìã</span>
                    <span>Mis Solicitudes</span>
                </a>
            </li>
            <li class="sidebar-item active">
                <a href="./history.html">
                    <span class="sidebar-icon">üìö</span>
                    <span>Historial</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./profile.html">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./notifications.html">
                    <span class="sidebar-icon">üîî</span>
                    <span>Notificaciones</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <div>
                    <h1>üìö Historial de Actividades</h1>
                    <p class="text-secondary">Revisa todas tus actividades pasadas: reservas, capacitaciones y m√°s</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="exportToPDF()">
                        üìÑ Exportar PDF
                    </button>
                    <button class="btn btn-outline" onclick="exportToExcel()">
                        üìä Exportar Excel
                    </button>
                </div>
            </div>

            <!-- Estad√≠sticas r√°pidas -->
            <div class="grid grid-cols-4 mt-lg">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üìö</div>
                        <h3 class="stat-number" id="totalReservations">0</h3>
                        <p class="text-secondary">Reservas Totales</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üéì</div>
                        <h3 class="stat-number" id="totalTrainings">0</h3>
                        <p class="text-secondary">Capacitaciones</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <h3 class="stat-number" id="totalHours">0</h3>
                        <p class="text-secondary">Horas Totales</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="stat-icon">üîß</div>
                        <h3 class="stat-number" id="uniqueResources">0</h3>
                        <p class="text-secondary">Recursos Usados</p>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mt-lg">
                <div class="card-body">
                    <form id="filterForm" class="filter-form">
                        <div class="form-group">
                            <label>Buscar</label>
                            <input type="text" id="searchInput" placeholder="Buscar por recurso o laboratorio..." class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="typeFilter" class="form-control">
                                <option value="">Todos</option>
                                <option value="reservation">Reservas</option>
                                <option value="training">Capacitaciones</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha desde</label>
                            <input type="date" id="dateFromFilter" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Fecha hasta</label>
                            <input type="date" id="dateToFilter" class="form-control">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Filtrar</button>
                            <button type="button" class="btn btn-outline" onclick="clearFilters()">Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Historial -->
            <div class="card mt-lg">
                <div class="card-header">
                    <h2>Actividades</h2>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Recurso/Lab</th>
                                    <th>Fecha</th>
                                    <th>Hora Inicio</th>
                                    <th>Hora Fin</th>
                                    <th>Duraci√≥n</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <tr>
                                    <td colspan="8" class="text-center">Cargando historial...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Detalles de Actividad -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>üìã Detalles de la Actividad</h2>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailsContent">
                <p class="text-center text-secondary">Cargando...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeDetailsModal()">Cerrar</button>
                <button class="btn btn-primary" id="downloadCertBtn" style="display: none;" onclick="downloadCertificate()">
                    üìÑ Descargar Certificado
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import api from '../assets/js/api.js';
        import { formatDate, showNotification } from '../assets/js/utils.js';
        import { requireAuth, getCurrentUser, logout as authLogout } from '../assets/js/auth.js';

        // Verificar autenticaci√≥n
        requireAuth();

        // Hacer logout disponible globalmente
        window.logout = authLogout;

        // Variables globales
        let allHistory = [];
        let currentActivity = null;

        // Cargar usuario
        const user = getCurrentUser();
        if (user) {
            document.getElementById('userName').textContent = user.name;
        }

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                // Cargar historial
                allHistory = await api.getHistory();
                renderHistory(allHistory);
                updateStats(allHistory);

                // Cargar notificaciones
                const notifications = await api.getNotifications();
                const unread = notifications.filter(n => !n.read).length;
                document.getElementById('notificationCount').textContent = unread;

            } catch (error) {
                console.error('Error al cargar datos:', error);
                showNotification('Error al cargar historial', 'error');
            }
        }

        // Actualizar estad√≠sticas
        function updateStats(history) {
            const reservations = history.filter(h => h.type === 'reservation').length;
            const trainings = history.filter(h => h.type === 'training').length;
            
            // Calcular horas totales
            let totalMinutes = 0;
            history.forEach(item => {
                if (item.type === 'reservation' && item.time_from && item.time_to) {
                    const start = new Date(`2000-01-01T${item.time_from}`);
                    const end = new Date(`2000-01-01T${item.time_to}`);
                    totalMinutes += (end - start) / 1000 / 60;
                } else if (item.type === 'training' && item.duration) {
                    // Extraer horas de la cadena (ej: "3 horas" o "2 horas")
                    const match = item.duration.match(/(\d+)/);
                    if (match) {
                        totalMinutes += parseInt(match[1]) * 60;
                    }
                }
            });
            const totalHours = Math.round(totalMinutes / 60);

            // Contar recursos √∫nicos (solo de reservas)
            const resourceNames = history
                .filter(h => h.type === 'reservation' && h.resource_name)
                .map(h => h.resource_name);
            const uniqueResources = new Set(resourceNames).size;
            
            document.getElementById('totalReservations').textContent = reservations;
            document.getElementById('totalTrainings').textContent = trainings;
            document.getElementById('totalHours').textContent = totalHours;
            document.getElementById('uniqueResources').textContent = uniqueResources;
        }

        // Renderizar historial
        function renderHistory(history) {
            const tbody = document.getElementById('historyTable');
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay actividades en el historial</td></tr>';
                return;
            }

            tbody.innerHTML = history.map(item => {
                const typeIcon = item.type === 'reservation' ? 'üìö' : 'üéì';
                const typeText = item.type === 'reservation' ? 'Reserva' : 'Capacitaci√≥n';
                
                // Obtener horarios y duraci√≥n seg√∫n el tipo
                let timeStart = 'N/A';
                let timeEnd = 'N/A';
                let duration = 'N/A';
                
                if (item.type === 'reservation') {
                    timeStart = item.time_from || 'N/A';
                    timeEnd = item.time_to || 'N/A';
                    duration = calculateDuration(item.time_from, item.time_to);
                } else if (item.type === 'training') {
                    duration = item.duration || 'N/A';
                }
                
                // Nombre del recurso/capacitaci√≥n
                const displayName = item.resource_name || item.title || 'N/A';
                
                return `
                    <tr>
                        <td>
                            <span style="font-size: 1.2rem;">${typeIcon}</span>
                            ${typeText}
                        </td>
                        <td>
                            <strong>${displayName}</strong><br>
                            <small class="text-secondary">${item.lab_name}</small>
                        </td>
                        <td>${formatDate(item.date, 'DD/MM/YYYY')}</td>
                        <td>${timeStart}</td>
                        <td>${timeEnd}</td>
                        <td>${duration}</td>
                        <td>
                            <span class="badge badge-${item.status}">
                                ${getStatusText(item.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="viewDetails(${item.id})">Ver</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateDuration(start, end) {
            if (!start || !end) return 'N/A';
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            const diffMinutes = (endTime - startTime) / 1000 / 60;
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            }
            return `${minutes}min`;
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': 'Completada',
                'cancelled': 'Cancelada',
                'no-show': 'No asisti√≥'
            };
            return statusMap[status] || status;
        }

        // Filtros
        document.getElementById('filterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            applyFilters();
        });

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            let filtered = allHistory;

            if (search) {
                filtered = filtered.filter(item => {
                    const resourceName = (item.resource_name || item.title || '').toLowerCase();
                    const labName = (item.lab_name || '').toLowerCase();
                    return resourceName.includes(search) || labName.includes(search);
                });
            }

            if (type) {
                filtered = filtered.filter(item => item.type === type);
            }

            if (dateFrom) {
                filtered = filtered.filter(item => item.date >= dateFrom);
            }

            if (dateTo) {
                filtered = filtered.filter(item => item.date <= dateTo);
            }

            renderHistory(filtered);
        }

        window.clearFilters = function() {
            document.getElementById('filterForm').reset();
            renderHistory(allHistory);
        };

        // Ver detalles
        window.viewDetails = function(id) {
            const item = allHistory.find(h => h.id === id);
            if (!item) return;

            currentActivity = item;

            const typeIcon = item.type === 'reservation' ? 'üìö' : 'üéì';
            const typeText = item.type === 'reservation' ? 'Reserva' : 'Capacitaci√≥n';

            const content = document.getElementById('detailsContent');
            
            // Generar HTML diferente seg√∫n el tipo
            let detailsHTML = '';
            
            if (item.type === 'reservation') {
                const duration = calculateDuration(item.time_from, item.time_to);
                detailsHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${typeIcon} ${typeText}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Estado:</strong>
                            <span class="badge badge-${item.status}">${getStatusText(item.status)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Recurso:</strong>
                            <span>${item.resource_name}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Laboratorio:</strong>
                            <span>${item.lab_name}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Fecha:</strong>
                            <span>${formatDate(item.date, 'DD/MM/YYYY')}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Horario:</strong>
                            <span>${item.time_from} - ${item.time_to}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Duraci√≥n:</strong>
                            <span>${duration}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Creada:</strong>
                            <span>${formatDate(item.created_at, 'DD/MM/YYYY HH:mm')}</span>
                        </div>
                    </div>
                `;
            } else if (item.type === 'training') {
                detailsHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${typeIcon} ${typeText}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Estado:</strong>
                            <span class="badge badge-${item.status}">${getStatusText(item.status)}</span>
                        </div>
                        <div class="detail-item full-width">
                            <strong>Capacitaci√≥n:</strong>
                            <span>${item.title}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Laboratorio:</strong>
                            <span>${item.lab_name}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Instructor:</strong>
                            <span>${item.instructor || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Fecha:</strong>
                            <span>${formatDate(item.date, 'DD/MM/YYYY')}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Duraci√≥n:</strong>
                            <span>${item.duration}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Certificado:</strong>
                            <span>${item.certificate ? '‚úÖ Disponible' : '‚ùå No disponible'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Creada:</strong>
                            <span>${formatDate(item.created_at, 'DD/MM/YYYY HH:mm')}</span>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = detailsHTML;

            // Mostrar bot√≥n de certificado solo para capacitaciones completadas con certificado
            const certBtn = document.getElementById('downloadCertBtn');
            if (item.type === 'training' && item.status === 'completed' && item.certificate) {
                certBtn.style.display = 'inline-block';
            } else {
                certBtn.style.display = 'none';
            }

            document.getElementById('detailsModal').classList.add('show');
        };

        window.closeDetailsModal = function() {
            document.getElementById('detailsModal').classList.remove('show');
            currentActivity = null;
        };

        // Cerrar modal al hacer clic en el overlay
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeDetailsModal();
            }
        });

        // Descargar certificado
        window.downloadCertificate = function() {
            if (!currentActivity) return;
            
            showNotification('Generando certificado...', 'info');
            
            // Simular descarga (en producci√≥n, esto har√≠a una petici√≥n al backend)
            setTimeout(() => {
                const name = currentActivity.title || currentActivity.resource_name;
                showNotification(`Certificado de "${name}" descargado`, 'success');
            }, 1000);
        };

        // Exportar a PDF
        window.exportToPDF = function() {
            showNotification('Generando PDF...', 'info');
            
            try {
                // Obtener las actividades actualmente mostradas en la tabla
                const filteredData = getCurrentFilteredData();
                
                if (filteredData.length === 0) {
                    showNotification('No hay actividades para exportar', 'warning');
                    return;
                }

                // Crear documento PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuraci√≥n de colores
                const primaryColor = [41, 128, 185]; // Azul
                const textColor = [51, 51, 51]; // Gris oscuro
                
                // T√≠tulo del documento
                doc.setFontSize(20);
                doc.setTextColor(...primaryColor);
                doc.text('Reporte de Historial de Actividades', 14, 20);
                
                // Descripci√≥n
                doc.setFontSize(11);
                doc.setTextColor(...textColor);
                doc.text('Este reporte contiene el historial de actividades acad√©micas', 14, 28);
                doc.text('incluyendo reservas de recursos y capacitaciones completadas.', 14, 33);
                
                // Informaci√≥n del usuario
                const user = getCurrentUser();
                doc.setFontSize(10);
                doc.text(`Usuario: ${user.name}`, 14, 41);
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, 14, 46);
                
                // Estad√≠sticas generales
                const stats = calculateStatsFromData(filteredData);
                doc.setFontSize(10);
                doc.setTextColor(...primaryColor);
                doc.text('Resumen:', 14, 55);
                doc.setTextColor(...textColor);
                doc.text(`Total de actividades: ${filteredData.length}`, 20, 60);
                doc.text(`Reservas: ${stats.reservations}`, 20, 65);
                doc.text(`Capacitaciones: ${stats.trainings}`, 20, 70);
                doc.text(`Horas totales: ${stats.hours}`, 20, 75);
                
                // Preparar datos para la tabla
                const tableData = filteredData.map(item => {
                    const typeIcon = item.type === 'reservation' ? 'üìö' : 'üéì';
                    const typeText = item.type === 'reservation' ? 'Reserva' : 'Capacitaci√≥n';
                    const displayName = item.resource_name || item.title || 'N/A';
                    
                    let timeStart = 'N/A';
                    let timeEnd = 'N/A';
                    let duration = 'N/A';
                    
                    if (item.type === 'reservation') {
                        timeStart = item.time_from || 'N/A';
                        timeEnd = item.time_to || 'N/A';
                        duration = calculateDuration(item.time_from, item.time_to);
                    } else if (item.type === 'training') {
                        duration = item.duration || 'N/A';
                    }
                    
                    return [
                        typeText,
                        displayName,
                        item.lab_name,
                        formatDate(item.date, 'DD/MM/YYYY'),
                        timeStart,
                        timeEnd,
                        duration,
                        getStatusText(item.status)
                    ];
                });
                
                // Generar tabla
                doc.autoTable({
                    startY: 82,
                    head: [['Tipo', 'Recurso/Capacitaci√≥n', 'Laboratorio', 'Fecha', 'Hora Inicio', 'Hora Fin', 'Duraci√≥n', 'Estado']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: primaryColor,
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 7,
                        textColor: textColor,
                        cellPadding: 2
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { cellWidth: 20 },      // Tipo
                        1: { cellWidth: 42 },      // Recurso/Capacitaci√≥n
                        2: { cellWidth: 36 },      // Laboratorio
                        3: { cellWidth: 20 },      // Fecha
                        4: { cellWidth: 14 },      // Hora Inicio
                        5: { cellWidth: 14 },      // Hora Fin
                        6: { cellWidth: 16 },      // Duraci√≥n
                        7: { cellWidth: 22 }       // Estado
                    },
                    margin: { left: 14, right: 14 }
                });
                
                // Pie de p√°gina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(
                        `P√°gina ${i} de ${pageCount}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                    doc.text(
                        'Gesti√≥n de Laboratorios Acad√©micos',
                        14,
                        doc.internal.pageSize.getHeight() - 10
                    );
                }
                
                // Guardar el PDF
                const fileName = `Historial_Actividades_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF exportado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error al exportar PDF:', error);
                showNotification('Error al generar el PDF', 'error');
            }
        };

        // Obtener datos actualmente filtrados en la tabla
        function getCurrentFilteredData() {
            const tbody = document.getElementById('historyTable');
            const rows = tbody.querySelectorAll('tr');
            
            // Si solo hay una fila y es el mensaje de "No hay actividades"
            if (rows.length === 1 && rows[0].cells.length === 1) {
                return [];
            }
            
            // Obtener los IDs de las filas visibles
            const visibleIds = Array.from(rows)
                .map(row => {
                    const viewBtn = row.querySelector('button[onclick^="viewDetails"]');
                    if (viewBtn) {
                        const match = viewBtn.getAttribute('onclick').match(/viewDetails\((\d+)\)/);
                        return match ? parseInt(match[1]) : null;
                    }
                    return null;
                })
                .filter(id => id !== null);
            
            // Filtrar allHistory para obtener solo los items visibles
            return allHistory.filter(item => visibleIds.includes(item.id));
        }

        // Calcular estad√≠sticas de un conjunto de datos
        function calculateStatsFromData(data) {
            const reservations = data.filter(h => h.type === 'reservation').length;
            const trainings = data.filter(h => h.type === 'training').length;
            
            let totalMinutes = 0;
            data.forEach(item => {
                if (item.type === 'reservation' && item.time_from && item.time_to) {
                    const start = new Date(`2000-01-01T${item.time_from}`);
                    const end = new Date(`2000-01-01T${item.time_to}`);
                    totalMinutes += (end - start) / 1000 / 60;
                } else if (item.type === 'training' && item.duration) {
                    const match = item.duration.match(/(\d+)/);
                    if (match) {
                        totalMinutes += parseInt(match[1]) * 60;
                    }
                }
            });
            
            return {
                reservations,
                trainings,
                hours: Math.round(totalMinutes / 60)
            };
        }

        // Exportar a Excel
        window.exportToExcel = function() {
            showNotification('Generando Excel...', 'info');
            
            try {
                // Obtener las actividades actualmente mostradas en la tabla
                const filteredData = getCurrentFilteredData();
                
                if (filteredData.length === 0) {
                    showNotification('No hay actividades para exportar', 'warning');
                    return;
                }

                // Obtener informaci√≥n del usuario y fecha
                const user = getCurrentUser();
                const currentDate = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Calcular estad√≠sticas
                const stats = calculateStatsFromData(filteredData);

                // Crear el libro de Excel
                const wb = XLSX.utils.book_new();

                // ============================================
                // HOJA 1: INFORMACI√ìN DEL REPORTE
                // ============================================
                const infoData = [
                    ['REPORTE DE HISTORIAL DE ACTIVIDADES', ''],
                    ['', ''],
                    ['Descripci√≥n:', 'Este reporte contiene el historial de actividades acad√©micas incluyendo reservas de recursos y capacitaciones completadas.'],
                    ['', ''],
                    ['Usuario:', user.name],
                    ['Fecha de generaci√≥n:', currentDate],
                    ['', ''],
                    ['RESUMEN ESTAD√çSTICO', ''],
                    ['Total de actividades:', filteredData.length],
                    ['Reservas:', stats.reservations],
                    ['Capacitaciones:', stats.trainings],
                    ['Horas totales:', stats.hours + ' horas']
                ];

                const wsInfo = XLSX.utils.aoa_to_sheet(infoData);

                // Estilos para la hoja de informaci√≥n
                wsInfo['!cols'] = [
                    { wch: 28 },
                    { wch: 82 }
                ];

                // Definir rango de celdas para aplicar bordes
                const infoCells = [
                    'A1', 'B1', 'A2', 'B2', 'A3', 'B3', 'A4', 'B4',
                    'A5', 'B5', 'A6', 'B6', 'A7', 'B7', 'A8', 'B8',
                    'A9', 'B9', 'A10', 'B10', 'A11', 'B11', 'A12', 'B12'
                ];

                // Estilo de borde est√°ndar
                const borderStyle = {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                };

                // Aplicar bordes y estilos a todas las celdas
                infoCells.forEach(cell => {
                    if (!wsInfo[cell]) {
                        wsInfo[cell] = { v: '', t: 's' };
                    }
                    
                    wsInfo[cell].s = {
                        border: borderStyle,
                        alignment: { vertical: "center", horizontal: "left" }
                    };
                });

                // T√≠tulo principal (A1) - Combinar con B1
                if (wsInfo['A1']) {
                    wsInfo['A1'].s = {
                        font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2980B9" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: borderStyle
                    };
                }
                if (wsInfo['B1']) {
                    wsInfo['B1'].s = {
                        font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2980B9" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: borderStyle
                    };
                }

                // Fila vac√≠a 2
                ['A2', 'B2'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            fill: { fgColor: { rgb: "FFFFFF" } },
                            border: borderStyle
                        };
                    }
                });

                // Secci√≥n "Descripci√≥n" (A3)
                if (wsInfo['A3']) {
                    wsInfo['A3'].s = {
                        font: { bold: true, sz: 11 },
                        fill: { fgColor: { rgb: "D6EAF8" } },
                        alignment: { vertical: "center", horizontal: "left" },
                        border: borderStyle
                    };
                }
                if (wsInfo['B3']) {
                    wsInfo['B3'].s = {
                        font: { sz: 10 },
                        fill: { fgColor: { rgb: "EBF5FB" } },
                        alignment: { vertical: "center", horizontal: "left", wrapText: true },
                        border: borderStyle
                    };
                }

                // Fila vac√≠a 4
                ['A4', 'B4'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            fill: { fgColor: { rgb: "FFFFFF" } },
                            border: borderStyle
                        };
                    }
                });

                // Campos de informaci√≥n (Usuario y Fecha) - A5, A6
                ['A5', 'A6'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            font: { bold: true, sz: 11 },
                            fill: { fgColor: { rgb: "ECF0F1" } },
                            alignment: { vertical: "center", horizontal: "left" },
                            border: borderStyle
                        };
                    }
                });

                // Valores de informaci√≥n - B5, B6
                ['B5', 'B6'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            font: { sz: 10 },
                            fill: { fgColor: { rgb: "F8F9F9" } },
                            alignment: { vertical: "center", horizontal: "left" },
                            border: borderStyle
                        };
                    }
                });

                // Fila vac√≠a 7
                ['A7', 'B7'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            fill: { fgColor: { rgb: "FFFFFF" } },
                            border: borderStyle
                        };
                    }
                });

                // T√≠tulo de resumen estad√≠stico (A8 y B8)
                if (wsInfo['A8']) {
                    wsInfo['A8'].s = {
                        font: { bold: true, sz: 13, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "27AE60" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: borderStyle
                    };
                }
                if (wsInfo['B8']) {
                    wsInfo['B8'].s = {
                        font: { bold: true, sz: 13, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "27AE60" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: borderStyle
                    };
                }

                // Campos de estad√≠sticas (A9-A12)
                ['A9', 'A10', 'A11', 'A12'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            font: { bold: true, sz: 11 },
                            fill: { fgColor: { rgb: "D5F4E6" } },
                            alignment: { vertical: "center", horizontal: "left" },
                            border: borderStyle
                        };
                    }
                });

                // Valores de estad√≠sticas (B9-B12)
                ['B9', 'B10', 'B11', 'B12'].forEach(cell => {
                    if (wsInfo[cell]) {
                        wsInfo[cell].s = {
                            font: { sz: 11, bold: true },
                            fill: { fgColor: { rgb: "EAFAF1" } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: borderStyle
                        };
                    }
                });

                // Configurar altura de filas
                wsInfo['!rows'] = [
                    { hpt: 30 },  // A1 - T√≠tulo
                    { hpt: 5 },   // A2 - Espacio
                    { hpt: 35 },  // A3 - Descripci√≥n
                    { hpt: 5 },   // A4 - Espacio
                    { hpt: 22 },  // A5 - Usuario
                    { hpt: 22 },  // A6 - Fecha
                    { hpt: 5 },   // A7 - Espacio
                    { hpt: 28 },  // A8 - T√≠tulo estad√≠sticas
                    { hpt: 22 },  // A9 - Total
                    { hpt: 22 },  // A10 - Reservas
                    { hpt: 22 },  // A11 - Capacitaciones
                    { hpt: 22 }   // A12 - Horas
                ];

                // Configurar merge de celdas para los t√≠tulos
                wsInfo['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },  // A1:B1 - T√≠tulo principal
                    { s: { r: 7, c: 0 }, e: { r: 7, c: 1 } }   // A8:B8 - T√≠tulo estad√≠sticas
                ];

                XLSX.utils.book_append_sheet(wb, wsInfo, 'Informaci√≥n');

                // ============================================
                // HOJA 2: TABLA DE ACTIVIDADES
                // ============================================
                const tableHeaders = [
                    'Tipo',
                    'Recurso/Capacitaci√≥n',
                    'Laboratorio',
                    'Fecha',
                    'Hora Inicio',
                    'Hora Fin',
                    'Duraci√≥n',
                    'Estado'
                ];

                const tableData = filteredData.map((item, index) => {
                    const typeText = item.type === 'reservation' ? 'Reserva' : 'Capacitaci√≥n';
                    const displayName = item.resource_name || item.title || 'N/A';
                    
                    let timeStart = 'N/A';
                    let timeEnd = 'N/A';
                    let duration = 'N/A';
                    
                    if (item.type === 'reservation') {
                        timeStart = item.time_from || 'N/A';
                        timeEnd = item.time_to || 'N/A';
                        duration = calculateDuration(item.time_from, item.time_to);
                    } else if (item.type === 'training') {
                        duration = item.duration || 'N/A';
                    }
                    
                    return [
                        typeText,
                        displayName,
                        item.lab_name,
                        formatDate(item.date, 'DD/MM/YYYY'),
                        timeStart,
                        timeEnd,
                        duration,
                        getStatusText(item.status)
                    ];
                });

                // Combinar headers y datos
                const wsData = [tableHeaders, ...tableData];
                const wsActivities = XLSX.utils.aoa_to_sheet(wsData);

                // Ancho de columnas
                wsActivities['!cols'] = [
                    { wch: 16 },  // Tipo
                    { wch: 42 },  // Recurso/Capacitaci√≥n
                    { wch: 32 },  // Laboratorio
                    { wch: 13 },  // Fecha
                    { wch: 13 },  // Hora Inicio
                    { wch: 13 },  // Hora Fin
                    { wch: 13 },  // Duraci√≥n
                    { wch: 16 }   // Estado
                ];

                // Aplicar estilos a los headers (primera fila)
                const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1'];
                headerCells.forEach(cell => {
                    if (wsActivities[cell]) {
                        wsActivities[cell].s = {
                            font: { bold: true, sz: 11, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "2980B9" } },
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            }
                        };
                    }
                });

                // Aplicar estilos a las filas de datos (filas alternadas)
                for (let i = 0; i < tableData.length; i++) {
                    const rowNum = i + 2; // +2 porque la fila 1 es el header
                    const isEvenRow = i % 2 === 0;
                    const bgColor = isEvenRow ? "FFFFFF" : "F8F9FA";
                    
                    // Aplicar estilo a cada celda de la fila
                    headerCells.forEach((headerCell, colIndex) => {
                        const cell = headerCell.replace('1', rowNum);
                        if (wsActivities[cell]) {
                            wsActivities[cell].s = {
                                font: { sz: 10 },
                                fill: { fgColor: { rgb: bgColor } },
                                alignment: { 
                                    horizontal: colIndex === 0 || colIndex === 7 ? "center" : "left",
                                    vertical: "center" 
                                },
                                border: {
                                    top: { style: "thin", color: { rgb: "E0E0E0" } },
                                    bottom: { style: "thin", color: { rgb: "E0E0E0" } },
                                    left: { style: "thin", color: { rgb: "E0E0E0" } },
                                    right: { style: "thin", color: { rgb: "E0E0E0" } }
                                }
                            };

                            // Estilo especial para la columna de Estado (√∫ltima columna)
                            if (colIndex === 7) {
                                const statusText = wsActivities[cell].v;
                                let statusColor = "27AE60"; // Verde por defecto (Completada)
                                
                                if (statusText === "Cancelada") {
                                    statusColor = "E74C3C"; // Rojo
                                } else if (statusText === "No asisti√≥") {
                                    statusColor = "F39C12"; // Naranja
                                }
                                
                                wsActivities[cell].s.font = { 
                                    sz: 10, 
                                    bold: true,
                                    color: { rgb: statusColor }
                                };
                            }

                            // Estilo especial para la columna de Tipo
                            if (colIndex === 0) {
                                const typeText = wsActivities[cell].v;
                                const typeColor = typeText === "Reserva" ? "3498DB" : "9B59B6";
                                wsActivities[cell].s.font = { 
                                    sz: 10, 
                                    bold: true,
                                    color: { rgb: typeColor }
                                };
                            }
                        }
                    });
                }

                // Configurar altura de fila para el header
                wsActivities['!rows'] = [{ hpt: 25 }]; // Primera fila (header) m√°s alta

                XLSX.utils.book_append_sheet(wb, wsActivities, 'Actividades');

                // Generar el archivo Excel con estilos
                const fileName = `Historial_Actividades_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName, { 
                    bookType: 'xlsx', 
                    bookSST: false, 
                    type: 'binary',
                    cellStyles: true 
                });

                showNotification('Excel exportado exitosamente', 'success');

            } catch (error) {
                console.error('Error al exportar Excel:', error);
                showNotification('Error al generar el Excel', 'error');
            }
        };

        // Cargar datos al inicio
        loadInitialData();
    </script>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .navbar-container {
            height: 100%;
            padding: 0 var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand h2 {
            margin: 0;
            font-size: var(--font-size-xl);
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .navbar-notifications {
            position: relative;
            font-size: var(--font-size-2xl);
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: var(--spacing-lg) 0;
        }

        .sidebar-item {
            margin-bottom: var(--spacing-xs);
        }

        .sidebar-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .sidebar-item a:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sidebar-item.active a {
            background: var(--primary-light);
            color: white;
            font-weight: 500;
        }

        .sidebar-icon {
            font-size: var(--font-size-xl);
            width: 24px;
            text-align: center;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-lg);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .filter-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: var(--spacing-md);
            align-items: end;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item strong {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: bold;
            color: var(--primary);
            margin: var(--spacing-xs) 0;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .navbar-brand h2 {
                font-size: var(--font-size-lg);
            }

            .page-header {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
            }

            .filter-form {
                grid-template-columns: 1fr;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</body>
</html>
