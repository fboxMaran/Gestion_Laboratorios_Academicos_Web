<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Solicitud - Gesti√≥n de Laboratorios</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h2>üî¨ Gesti√≥n de Laboratorios</h2>
            </div>
            <div class="navbar-menu">
                <a href="./notifications.html" class="navbar-notifications">
                    üîî
                </a>
                <div class="navbar-user">
                    <span id="userName">Cargando...</span>
                    <button class="btn btn-sm btn-outline" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="./dashboard.html">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./search.html">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Recursos</span>
                </a>
            </li>
            <li class="sidebar-item active">
                <a href="./requests.html">
                    <span class="sidebar-icon">üìã</span>
                    <span>Mis Solicitudes</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./history.html">
                    <span class="sidebar-icon">üìö</span>
                    <span>Historial</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./profile.html">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./notifications.html">
                    <span class="sidebar-icon">üîî</span>
                    <span>Notificaciones</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Header con bot√≥n de regresar -->
            <div class="page-header">
                <div>
                    <a href="./requests.html" class="btn btn-outline">
                        ‚Üê Volver a Solicitudes
                    </a>
                    <h1 style="margin-top: 16px;">üìù Nueva Solicitud</h1>
                    <p class="text-secondary">Completa el formulario para solicitar un recurso o laboratorio</p>
                </div>
            </div>

            <!-- Formulario -->
            <div class="card mt-lg">
                <div class="card-body">
                    <form id="newRequestForm">
                        <div class="form-group">
                            <label for="requestLab">Laboratorio *</label>
                            <select id="requestLab" class="form-control" required>
                                <option value="">Seleccione un laboratorio</option>
                            </select>
                            <small class="text-secondary">Primero selecciona el laboratorio donde necesitas el recurso</small>
                        </div>

                        <div class="form-group">
                            <label for="requestResource">Recurso *</label>
                            <select id="requestResource" class="form-control" required>
                                <option value="">Primero seleccione un laboratorio</option>
                            </select>
                            <small class="text-secondary">El recurso que necesitas usar</small>
                        </div>

                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label for="requestDateFrom">Fecha Inicio *</label>
                                <input type="date" id="requestDateFrom" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="requestDateTo">Fecha Fin *</label>
                                <input type="date" id="requestDateTo" class="form-control" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label for="requestTimeFrom">Hora Inicio *</label>
                                <input type="time" id="requestTimeFrom" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="requestTimeTo">Hora Fin *</label>
                                <input type="time" id="requestTimeTo" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="requestPurpose">Prop√≥sito de la solicitud *</label>
                            <textarea id="requestPurpose" class="form-control" rows="4" placeholder="Describe el prop√≥sito de tu solicitud..." required></textarea>
                            <small class="text-secondary">Explica para qu√© necesitas el recurso (proyecto, pr√°ctica, investigaci√≥n, etc.)</small>
                        </div>

                        <div class="form-group">
                            <label for="requestNotes">Notas adicionales</label>
                            <textarea id="requestNotes" class="form-control" rows="3" placeholder="Informaci√≥n adicional relevante..."></textarea>
                            <small class="text-secondary">Informaci√≥n adicional que consideres importante</small>
                        </div>

                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Importante:</strong> Tu solicitud ser√° revisada por el personal administrativo. Recibir√°s una notificaci√≥n cuando sea procesada. Aseg√∫rate de verificar la disponibilidad del recurso antes de solicitar.
                        </div>

                        <div class="form-actions">
                            <a href="./requests.html" class="btn btn-outline btn-lg">Cancelar</a>
                            <button type="submit" class="btn btn-primary btn-lg">Enviar Solicitud</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import api from '../assets/js/api.js';
        import { showNotification } from '../assets/js/utils.js';
        import { requireAuth, getCurrentUser, logout as authLogout } from '../assets/js/auth.js';

        // Verificar autenticaci√≥n
        requireAuth();

        // Hacer logout disponible globalmente
        window.logout = authLogout;

        // Variables globales
        let allLabs = [];
        let allResources = [];

        // Cargar informaci√≥n del usuario
        async function loadUserInfo() {
            try {
                const profile = await api.getProfile();
                document.getElementById('userName').textContent = profile.name || 'Usuario';
            } catch (error) {
                console.error('[NewRequest] Error al cargar perfil:', error);
                const user = getCurrentUser();
                if (user) {
                    document.getElementById('userName').textContent = user.name;
                }
            }
        }

        // Cargar datos iniciales
        async function loadInitialData() {
            await loadUserInfo();
            try {
                // Cargar labs y recursos
                allLabs = await api.searchLabs();
                allResources = await api.searchResources();
                populateLabSelect();

                // Set fecha m√≠nima a hoy
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('requestDateFrom').min = today;
                document.getElementById('requestDateTo').min = today;

            } catch (error) {
                console.error('Error al cargar datos:', error);
                showNotification('Error al cargar datos', 'error');
            }
        }

        // Poblar select de laboratorios
        function populateLabSelect() {
            const select = document.getElementById('requestLab');
            select.innerHTML = '<option value="">Seleccione un laboratorio</option>' +
                allLabs.map(lab => `<option value="${lab.id}">${lab.name}</option>`).join('');
        }

        // Cambio de laboratorio -> cargar recursos
        document.getElementById('requestLab').addEventListener('change', async (e) => {
            const labId = parseInt(e.target.value);
            const resourceSelect = document.getElementById('requestResource');
            
            if (!labId) {
                resourceSelect.innerHTML = '<option value="">Primero seleccione un laboratorio</option>';
                return;
            }

            try {
                // Cargar recursos del laboratorio seleccionado desde el backend
                const labResources = await api.searchResources({ lab_id: labId });
                
                if (labResources.length === 0) {
                    resourceSelect.innerHTML = '<option value="">No hay recursos disponibles en este laboratorio</option>';
                    return;
                }

                resourceSelect.innerHTML = '<option value="">Seleccione un recurso</option>' +
                    labResources
                        .filter(res => res.status === 'DISPONIBLE') // Solo recursos disponibles
                        .map(res => `<option value="${res.id}">${res.name} - ${res.type}</option>`)
                        .join('');
                        
                if (resourceSelect.options.length === 1) {
                    resourceSelect.innerHTML += '<option value="" disabled>Todos los recursos est√°n ocupados</option>';
                }
            } catch (error) {
                console.error('Error al cargar recursos:', error);
                resourceSelect.innerHTML = '<option value="">Error al cargar recursos</option>';
            }
        });

        // Validar fecha fin
        document.getElementById('requestDateFrom').addEventListener('change', (e) => {
            const dateFrom = e.target.value;
            document.getElementById('requestDateTo').min = dateFrom;
        });

        // Enviar formulario
        document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const labId = parseInt(document.getElementById('requestLab').value);
            const resourceId = parseInt(document.getElementById('requestResource').value);
            const dateFrom = document.getElementById('requestDateFrom').value;
            const dateTo = document.getElementById('requestDateTo').value;
            const timeFrom = document.getElementById('requestTimeFrom').value;
            const timeTo = document.getElementById('requestTimeTo').value;
            const purpose = document.getElementById('requestPurpose').value;
            const notes = document.getElementById('requestNotes').value;

            // Validaci√≥n de fechas
            if (dateTo < dateFrom) {
                showNotification('La fecha de fin debe ser posterior a la fecha de inicio', 'error');
                return;
            }

            // Validaci√≥n de horas si es el mismo d√≠a
            if (dateFrom === dateTo && timeTo <= timeFrom) {
                showNotification('La hora de fin debe ser posterior a la hora de inicio', 'error');
                return;
            }

            // Construir timestamps ISO
            const requestedFrom = `${dateFrom}T${timeFrom}:00`;
            const requestedTo = `${dateTo}T${timeTo}:00`;

            // Obtener datos del usuario actual
            const currentUser = getCurrentUser();
            
            const requestData = {
                lab_id: labId,
                purpose: purpose,
                requester_role: currentUser?.role || 'Estudiante',
                user_id: currentUser?.id,
                starts_at: requestedFrom,
                ends_at: requestedTo,
                reason: purpose,
                items: [
                    {
                        resource_id: resourceId,
                        qty: 1
                    }
                ]
            };

            try {
                const response = await api.createRequest(requestData);
                showNotification('Solicitud creada exitosamente', 'success');
                console.log('Solicitud creada:', response);
                // Redirigir a la p√°gina de solicitudes despu√©s de 1 segundo
                setTimeout(() => {
                    window.location.href = './requests.html';
                }, 1000);
            } catch (error) {
                console.error('Error al crear solicitud:', error);
                showNotification(error.message || 'Error al crear la solicitud', 'error');
            }
        });

        // Cargar datos al inicio
        loadInitialData();
    </script>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .navbar-container {
            height: 100%;
            padding: 0 var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand h2 {
            margin: 0;
            font-size: var(--font-size-xl);
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .navbar-notifications {
            position: relative;
            font-size: var(--font-size-2xl);
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: var(--spacing-lg) 0;
        }

        .sidebar-item {
            margin-bottom: var(--spacing-xs);
        }

        .sidebar-item a {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .sidebar-item a:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .sidebar-item.active a {
            background: var(--primary-light);
            color: white;
            font-weight: 500;
        }

        .sidebar-icon {
            font-size: var(--font-size-xl);
            width: 24px;
            text-align: center;
        }

        .page-header {
            margin-bottom: var(--spacing-xl);
        }

        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .navbar-brand h2 {
                font-size: var(--font-size-lg);
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html>
