<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disponibilidad y Recursos - LabTEC</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/labs-availability.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h2>üìÖ Disponibilidad y Recursos</h2>
            </div>
            <div class="navbar-menu">
                <a href="../notifications.html" class="navbar-notifications">
                    üîî
                </a>
                <div class="navbar-user">
                    <span id="userName">Cargando...</span>
                    <button class="btn btn-sm btn-outline" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="../dashboard.html">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="./manage.html">
                    <span class="sidebar-icon">üî¨</span>
                    <span>Mi Laboratorio</span>
                </a>
            </li>
            <li class="sidebar-item active">
                <a href="./availability.html">
                    <span class="sidebar-icon">üìÖ</span>
                    <span>Disponibilidad</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="../search.html">
                    <span class="sidebar-icon">üîç</span>
                    <span>Buscar Recursos</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="../requests.html">
                    <span class="sidebar-icon">üìã</span>
                    <span>Solicitudes</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="../profile.html">
                    <span class="sidebar-icon">üë§</span>
                    <span>Mi Perfil</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="../notifications.html">
                    <span class="sidebar-icon">üîî</span>
                    <span>Notificaciones</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Header -->
            <div class="page-header">
                <div>
                    <h1 id="labName">Gesti√≥n de Disponibilidad y Recursos</h1>
                    <p class="text-secondary">Administra horarios, recursos y cat√°logo del laboratorio</p>
                </div>
                <div class="header-actions">
                    <button id="btnNewSlot" class="btn btn-primary">
                        ‚ûï Nuevo Horario
                    </button>
                    <button id="btnNewResource" class="btn btn-primary">
                        üîß Nuevo Recurso
                    </button>
                </div>
            </div>

            <!-- Alertas -->
            <div id="alertContainer"></div>

            <!-- Selector de Laboratorio -->
            <div class="card mt-xl" id="labSelectorCard" style="display: none;">
                <div class="card-body">
                    <div class="form-group">
                        <label for="labSelector">Seleccionar Laboratorio</label>
                        <select id="labSelector" class="form-control">
                            <option value="">Cargando laboratorios...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs-container mt-xl">
                <div class="tabs-nav">
                    <button class="tab-btn active" data-tab="calendar">
                        üìÖ Calendario
                    </button>
                    <button class="tab-btn" data-tab="resources">
                        üîß Cat√°logo de Recursos
                    </button>
                    <button class="tab-btn" data-tab="changelog">
                        üìù Bit√°cora de Cambios
                    </button>
                    <button class="tab-btn" data-tab="subscriptions">
                        üîî Suscripciones
                    </button>
                </div>

                <!-- Tab Content: Calendario -->
                <div class="tab-content active" id="tab-calendar">
                    <div class="card">
                        <div class="card-header">
                            <h3>Calendario de Disponibilidad</h3>
                            <div class="calendar-controls">
                                <button id="btnPrevPeriod" class="btn btn-sm btn-outline">‚óÄ Anterior</button>
                                <select id="calendarView" class="form-control form-control-sm">
                                    <option value="week">Vista Semanal</option>
                                    <option value="month">Vista Mensual</option>
                                </select>
                                <button id="btnNextPeriod" class="btn btn-sm btn-outline">Siguiente ‚ñ∂</button>
                                <button id="btnToday" class="btn btn-sm btn-primary">Hoy</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filtros del Calendario -->
                            <div class="grid grid-cols-3 mb-md">
                                <div class="form-group">
                                    <label for="filterResourceCalendar">Filtrar por Recurso</label>
                                    <select id="filterResourceCalendar" class="form-control">
                                        <option value="">Todos los recursos</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filterStatusCalendar">Filtrar por Estado</label>
                                    <select id="filterStatusCalendar" class="form-control">
                                        <option value="">Todos los estados</option>
                                        <option value="DISPONIBLE">Disponible</option>
                                        <option value="BLOQUEADO">Bloqueado</option>
                                        <option value="RESERVADO">Reservado</option>
                                        <option value="MANTENIMIENTO">Mantenimiento</option>
                                        <option value="EXCLUSIVO">Exclusivo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button id="btnFilterCalendar" class="btn btn-primary" style="width: 100%;">üîç Filtrar</button>
                                </div>
                            </div>

                            <!-- Vista Semanal -->
                            <div id="calendarWeekView" class="calendar-view">
                                <div class="calendar-week-header">
                                    <div class="calendar-time-column"></div>
                                    <div class="calendar-day" data-day="0">Lunes</div>
                                    <div class="calendar-day" data-day="1">Martes</div>
                                    <div class="calendar-day" data-day="2">Mi√©rcoles</div>
                                    <div class="calendar-day" data-day="3">Jueves</div>
                                    <div class="calendar-day" data-day="4">Viernes</div>
                                    <div class="calendar-day" data-day="5">S√°bado</div>
                                    <div class="calendar-day" data-day="6">Domingo</div>
                                </div>
                                <div class="calendar-week-body" id="calendarWeekBody">
                                    <!-- Slots se renderizar√°n aqu√≠ -->
                                </div>
                            </div>

                            <!-- Vista Mensual -->
                            <div id="calendarMonthView" class="calendar-view" style="display: none;">
                                <div class="calendar-month-header" id="calendarMonthHeader">
                                    <!-- D√≠as de la semana -->
                                </div>
                                <div class="calendar-month-body" id="calendarMonthBody">
                                    <!-- D√≠as del mes se renderizar√°n aqu√≠ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Cat√°logo de Recursos -->
                <div class="tab-content" id="tab-resources">
                    <div class="card">
                        <div class="card-header">
                            <h3>Cat√°logo de Recursos</h3>
                            <button id="btnAddResource" class="btn btn-primary btn-sm">
                                ‚ûï Agregar Recurso
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Filtros de Recursos -->
                            <div class="grid grid-cols-4 mb-md">
                                <div class="form-group">
                                    <label for="filterResourceType">Tipo de Recurso</label>
                                    <select id="filterResourceType" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="EQUIPMENT">Equipos</option>
                                        <option value="CONSUMABLE">Consumibles</option>
                                        <option value="SOFTWARE">Software</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filterResourceState">Estado</label>
                                    <select id="filterResourceState" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="DISPONIBLE">Disponible</option>
                                        <option value="RESERVADO">Reservado</option>
                                        <option value="EN_MANTENIMIENTO">En Mantenimiento</option>
                                        <option value="INACTIVO">Inactivo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="searchResource">Buscar</label>
                                    <input type="text" id="searchResource" class="form-control" 
                                           placeholder="Nombre o c√≥digo...">
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button id="btnFilterResources" class="btn btn-primary" style="width: 100%;">üîç Filtrar</button>
                                </div>
                            </div>

                            <!-- Grid de Recursos -->
                            <div class="resources-grid" id="resourcesGrid">
                                <div class="text-center">Cargando recursos...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Bit√°cora de Cambios -->
                <div class="tab-content" id="tab-changelog">
                    <div class="card">
                        <div class="card-header">
                            <h3>Bit√°cora de Cambios en Disponibilidad</h3>
                            <div>
                                <button class="btn btn-outline btn-sm" id="btnExportChangelogPDF">üìÑ PDF</button>
                                <button class="btn btn-outline btn-sm" id="btnExportChangelogExcel">üìä Excel</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filtros de Bit√°cora -->
                            <div class="grid grid-cols-4 mb-md">
                                <div class="form-group">
                                    <label for="filterChangelogDateFrom">Fecha Desde</label>
                                    <input type="date" id="filterChangelogDateFrom" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="filterChangelogDateTo">Fecha Hasta</label>
                                    <input type="date" id="filterChangelogDateTo" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="filterChangelogEntity">Entidad</label>
                                    <select id="filterChangelogEntity" class="form-control">
                                        <option value="">Todas</option>
                                        <option value="slot">Horarios</option>
                                        <option value="resource">Recursos</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button id="btnFilterChangelog" class="btn btn-primary" style="width: 100%;">üîç Filtrar</button>
                                </div>
                            </div>

                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Fecha y Hora</th>
                                            <th>Usuario</th>
                                            <th>Entidad</th>
                                            <th>Acci√≥n</th>
                                            <th>Detalle</th>
                                        </tr>
                                    </thead>
                                    <tbody id="changelogTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center">Cargando bit√°cora...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Suscripciones -->
                <div class="tab-content" id="tab-subscriptions">
                    <div class="card">
                        <div class="card-header">
                            <h3>Suscripciones a Notificaciones</h3>
                            <button id="btnNewSubscription" class="btn btn-primary btn-sm">
                                ‚ûï Nueva Suscripci√≥n
                            </button>
                        </div>
                        <div class="card-body">
                            <p class="text-secondary mb-md">
                                Suscr√≠bete para recibir notificaciones autom√°ticas cuando recursos o espacios cambien a estado "Disponible".
                            </p>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Laboratorio</th>
                                            <th>Recurso</th>
                                            <th>Fecha de Suscripci√≥n</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subscriptionsTableBody">
                                        <tr>
                                            <td colspan="4" class="text-center">Cargando suscripciones...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Crear/Editar Slot de Calendario -->
    <div id="slotModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="slotModalTitle">Nuevo Horario</h3>
                <button class="modal-close" onclick="closeModal('slotModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="slotForm">
                    <input type="hidden" id="slotId" name="id">
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="slotStartDate">Fecha de Inicio *</label>
                            <input type="date" id="slotStartDate" name="start_date" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="slotStartTime">Hora de Inicio *</label>
                            <input type="time" id="slotStartTime" name="start_time" required class="form-control">
                        </div>
                    </div>
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="slotEndDate">Fecha de Fin *</label>
                            <input type="date" id="slotEndDate" name="end_date" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="slotEndTime">Hora de Fin *</label>
                            <input type="time" id="slotEndTime" name="end_time" required class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="slotResource">Recurso (Opcional)</label>
                        <select id="slotResource" name="resource_id" class="form-control">
                            <option value="">Espacio del laboratorio</option>
                        </select>
                        <small class="form-text">Dejar vac√≠o para bloquear el espacio completo del laboratorio</small>
                    </div>
                    <div class="form-group">
                        <label for="slotStatus">Estado *</label>
                        <select id="slotStatus" name="status" required class="form-control">
                            <option value="DISPONIBLE">Disponible</option>
                            <option value="BLOQUEADO">Bloqueado</option>
                            <option value="RESERVADO">Reservado</option>
                            <option value="MANTENIMIENTO">Mantenimiento</option>
                            <option value="EXCLUSIVO">Exclusivo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="slotTitle">T√≠tulo</label>
                        <input type="text" id="slotTitle" name="title" class="form-control" 
                               placeholder="Ej: Clase de Electr√≥nica">
                    </div>
                    <div class="form-group">
                        <label for="slotReason">Motivo</label>
                        <textarea id="slotReason" name="reason" rows="3" class="form-control" 
                                  placeholder="Descripci√≥n del motivo del bloqueo o disponibilidad..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('slotModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSaveSlot">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Recurso -->
    <div id="resourceModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="resourceModalTitle">Nuevo Recurso</h3>
                <button class="modal-close" onclick="closeModal('resourceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <input type="hidden" id="resourceId" name="id">
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="resourceName">Nombre del Recurso *</label>
                            <input type="text" id="resourceName" name="name" required class="form-control" 
                                   placeholder="Ej: Osciloscopio Digital">
                        </div>
                        <div class="form-group">
                            <label for="resourceType">Tipo *</label>
                            <select id="resourceType" name="type" required class="form-control">
                                <option value="EQUIPMENT">Equipo</option>
                                <option value="CONSUMABLE">Consumible</option>
                                <option value="SOFTWARE">Software</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label for="resourceInventoryCode">C√≥digo de Inventario</label>
                            <input type="text" id="resourceInventoryCode" name="inventory_code" class="form-control" 
                                   placeholder="Ej: INV-001">
                        </div>
                        <div class="form-group">
                            <label for="resourceState">Estado *</label>
                            <select id="resourceState" name="state" required class="form-control">
                                <option value="DISPONIBLE">Disponible</option>
                                <option value="RESERVADO">Reservado</option>
                                <option value="EN_MANTENIMIENTO">En Mantenimiento</option>
                                <option value="INACTIVO">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="resourceLocation">Ubicaci√≥n</label>
                        <input type="text" id="resourceLocation" name="location" class="form-control" 
                               placeholder="Ej: Estante A, Sala 201">
                    </div>
                    <div class="form-group">
                        <label for="resourceDescription">Descripci√≥n</label>
                        <textarea id="resourceDescription" name="description" rows="3" class="form-control" 
                                  placeholder="Descripci√≥n general del recurso..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resourceTechSheet">Ficha T√©cnica</label>
                        <textarea id="resourceTechSheet" name="tech_sheet" rows="6" class="form-control" 
                                  placeholder="Especificaciones t√©cnicas, caracter√≠sticas, manual de uso, etc..."></textarea>
                        <small class="form-text">Informaci√≥n t√©cnica detallada del recurso</small>
                    </div>
                    <div class="form-group">
                        <label for="resourceLastMaintenance">√öltimo Mantenimiento</label>
                        <input type="date" id="resourceLastMaintenance" name="last_maintenance_date" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('resourceModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSaveResource">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles de Recurso -->
    <div id="resourceDetailModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="resourceDetailTitle">Detalles del Recurso</h3>
                <button class="modal-close" onclick="closeModal('resourceDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="resourceDetailBody">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('resourceDetailModal')">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnEditResourceFromDetail">Editar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva Suscripci√≥n -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Suscripci√≥n</h3>
                <button class="modal-close" onclick="closeModal('subscriptionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="subscriptionForm">
                    <div class="form-group">
                        <label for="subscriptionResource">Recurso (Opcional)</label>
                        <select id="subscriptionResource" name="resource_id" class="form-control">
                            <option value="">Todo el laboratorio</option>
                        </select>
                        <small class="form-text">Selecciona un recurso espec√≠fico o deja vac√≠o para suscribirte a todo el laboratorio</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('subscriptionModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSaveSubscription">Suscribirse</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../../assets/js/config.js"></script>
    <script type="module" src="../../assets/js/api.js"></script>
    <script type="module" src="../../assets/js/auth.js"></script>
    <script type="module" src="../../assets/js/labs-availability.js"></script>
</body>
</html>